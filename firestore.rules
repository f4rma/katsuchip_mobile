rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function untuk check role - inline untuk menghindari recursion
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return request.auth != null && getUserRole() == 'admin';
    }
    
    function isKurir() {
      return request.auth != null && getUserRole() == 'kurir';
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow authenticated user to read their own document
      allow read: if isOwner(userId);
      
      // Admin can read all users - simple check without recursion
      allow list, get: if request.auth != null;
      
      // Allow create user:
      // 1. Admin bisa create user baru
      // 2. Customer self-register (authenticated user creating their own document)
      // 3. Kurir registrasi dengan token valid (role = 'kurir')
      allow create: if isAdmin() || 
                       (request.auth != null && 
                        request.resource.data.role == 'customer' &&
                        request.auth.uid == userId) ||
                       (request.auth != null &&
                        request.resource.data.role == 'kurir' &&
                        request.auth.uid == userId);
      
      // Admin bisa update isActive dan field lainnya
      allow update: if isAdmin();
      
      // User bisa update data sendiri (kecuali role dan isActive)
      // Izinkan update meskipun field belum ada (untuk profile_setup pertama kali)
      allow update: if isOwner(userId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isActive']);
      
      // Subcollection: notifications
      match /notifications/{notifId} {
        allow read, write: if isOwner(userId) || isAdmin();
        
        // Kurir bisa CREATE notifikasi ke customer (delivery updates)
        allow create: if isKurir();
      }
      
      // Subcollection: cart
      match /cart/{itemId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // Subcollection: orders
      match /orders/{orderId} {
        allow read, write: if isOwner(userId) || isAdmin() || isKurir();
        
        // Allow server-side updates (Cloud Functions/Webhook)
        // Cloud Functions berjalan tanpa auth context, jadi request.auth == null
        allow write: if request.auth == null;
      }
      
      // Subcollection: addresses (untuk shipping address)
      match /addresses/{addressId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // Subcollection: deliveries
      match /deliveries/{deliveryId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId);
      }
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Admin bisa baca dan update semua order
      allow read, write: if isAdmin();
      
      // Kurir bisa baca order yang statusnya waiting_pickup atau on_delivery
      allow read: if isKurir();
      
      // Kurir bisa update order (untuk update status pengiriman)
      allow update: if isKurir();
      
      // User yang buat order bisa baca order sendiri
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // User bisa create order sendiri (userId harus match dengan auth.uid)
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      
      // User bisa update order sendiri (untuk simulasi pembayaran atau perubahan status)
      // Izinkan update jika userId match ATAU jika document belum ada userId (backward compatibility)
      allow update: if request.auth != null && 
                       (resource.data.userId == request.auth.uid || 
                        !('userId' in resource.data));
                        
      // Allow server-side updates (Cloud Functions/Webhook)
      allow write: if request.auth == null;
    }
    
    // Orders subcollection (untuk collectionGroup query di laporan)
    match /{path=**}/orders/{orderId} {
      // Admin bisa query semua orders dari collectionGroup
      allow read: if isAdmin();
      
      // Kurir bisa read dan WRITE semua orders (untuk ambil pesanan & update status)
      allow read, write: if isKurir();
      
      // User bisa baca order sendiri
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // User bisa update order sendiri (untuk cancel dll)
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Menu collection (nama collection: 'menus')
    match /menus/{menuId} {
      // Public bisa baca menu (untuk tampilan app)
      allow read: if true;
      
      // Hanya admin yang bisa create, update, delete menu
      allow write: if isAdmin();
      
      // Allow server-side updates untuk stok (dari cart_repository saat checkout)
      // Ini penting untuk pengurangan stok otomatis
      allow update: if request.auth != null;
    }
    
    // Cart collection
    match /cart/{cartId} {
      // User hanya bisa baca/write cart sendiri
      allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }
    
    // Notifications collection (global, jika ada)
    match /notifications/{notifId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Kurir invitations collection
    match /kurir_invitations/{invitationId} {
      // Admin bisa CRUD semua invitation
      allow read, write: if isAdmin();
      
      // Public read dengan token validation (untuk halaman register kurir)
      // Hanya bisa read jika status = pending dan token belum expired
      allow read: if resource.data.status == 'pending' && 
                     resource.data.tokenExpiry > request.time;
      
      // Allow delete untuk kurir yang sudah registrasi (cleanup)
      allow delete: if request.auth != null && 
                       request.auth.token.email == resource.data.email;
    }
    
    // Notification logs collection
    match /notification_logs/{logId} {
      // Admin bisa CRUD semua logs
      allow read, write: if isAdmin();
      
      // Kurir bisa create logs (untuk tracking delivery updates)
      allow create: if isKurir();
      
      // System/authenticated users bisa create logs
      allow create: if request.auth != null;
    }
  }
}
